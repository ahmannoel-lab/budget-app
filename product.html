<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Product Detail • Budget App</title>
  <style>
    /* Design Tokens - Match Overview & Discovery */
    :root {
      color-scheme: dark;
      font-family: "SF Pro", "Inter", "Helvetica Neue", Arial, sans-serif;

      --bg-primary: #0C0C0D;
      --bg-elevated: #141416;
      --bg-surface: #1B1C1E;
      --glass-tint: rgba(20, 20, 22, 0.55);

      --text-high: #F2F2F2;
      --text-medium: #CFCFD2;
      --text-low: #9A9AA0;

      --accent: #D5B06F;
      --accent-warm-gold: #D5B06F;
      --accent-dark: #B8975A;
      --accent-amber: #FFBF66;

      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-strong: rgba(255, 255, 255, 0.12);

      --shadow-s: 0 2px 8px rgba(0, 0, 0, 0.25);
      --shadow-m: 0 8px 24px rgba(0, 0, 0, 0.35);
      --shadow-l: 0 18px 48px rgba(0, 0, 0, 0.45);

      --radius-lg: 20px;
      --radius-xl: 24px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      overflow-x: hidden;
    }

    body {
      background: #3D2F28;
      color: var(--text-high);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
      padding: 0;
    }

    /* Header - Transparent, floats over image */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: transparent;
      padding: calc(env(safe-area-inset-top, 44px) + 12px) 20px 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: none;
    }

    .back-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(12, 12, 13, 0.6);
      backdrop-filter: blur(20px) saturate(1.8);
      -webkit-backdrop-filter: blur(20px) saturate(1.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 18px;
      color: var(--text-high);
    }

    .back-btn:active {
      transform: scale(0.94);
      background: rgba(12, 12, 13, 0.8);
    }

    .save-btn {
      padding: 8px 16px;
      border-radius: 20px;
      background: rgba(12, 12, 13, 0.6);
      backdrop-filter: blur(20px) saturate(1.8);
      -webkit-backdrop-filter: blur(20px) saturate(1.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
      font-weight: 500;
      color: var(--text-high);
      cursor: pointer;
      transition: all 0.2s;
    }

    .save-btn:active {
      transform: scale(0.96);
      background: rgba(12, 12, 13, 0.8);
    }

    .save-btn.saved {
      background: var(--accent);
      color: #1A1A1A;
      border-color: var(--accent);
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    /* Main Container */
    .product-container {
      min-height: 100vh;
      padding-top: 0;
      padding-bottom: calc(env(safe-area-inset-bottom, 34px) + 20px);
      overflow-y: auto;
    }

    /* Hero Image - Top 50vh, Full Width Edge-to-Edge, Extends Behind Status Bar */
    .hero-section {
      position: relative;
      width: 100%;
      height: calc(50vh + env(safe-area-inset-top, 44px));
      margin-top: calc(-1 * env(safe-area-inset-top, -44px));
      padding: 0;
      overflow: hidden;
      z-index: 1;
    }

    .hero-image-wrapper {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .hero-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 0 0 24px 24px;
    }

    /* Content Section */
    .content-section {
      margin-top: 0;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 0;
      padding: 32px 24px 60px 24px;
      padding-bottom: 200px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
      gap: 8px;
      max-width: 600px;
    }

    /* Brand/Source */
    .product-brand {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-medium);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 4px;
    }

    /* Title */
    .product-title {
      font-size: 40px;
      font-weight: 900;
      letter-spacing: -1px;
      line-height: 1.0;
      color: var(--text-high);
      margin-bottom: 8px;
      text-transform: uppercase;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
    }

    /* Price */
    .product-price {
      font-size: 28px;
      font-weight: 400;
      color: var(--text-high);
      margin-bottom: 16px;
      letter-spacing: -0.5px;
    }

    /* Affordability Bar - Seamless Bottom Integration */
    .affordability-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 80;
      background: linear-gradient(to top,
        #3D2F28 0%,
        rgba(61, 47, 40, 0.98) 30%,
        rgba(61, 47, 40, 0.85) 50%,
        rgba(61, 47, 40, 0.5) 75%,
        transparent 100%);
      padding: 20px 24px calc(env(safe-area-inset-bottom, 12px) + 24px) 24px;
      padding-top: 90px;
      border: none;
      pointer-events: none;
    }

    .affordability-top-label {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-high);
      text-align: left;
      margin-bottom: 8px;
      letter-spacing: -0.2px;
      pointer-events: auto;
    }

    .segments-container {
      display: flex;
      justify-content: flex-start;
      align-items: flex-end;
      gap: 4px;
      margin-bottom: 10px;
      height: 48px;
      width: 100%;
      pointer-events: auto;
    }

    .segment {
      width: 6px;
      height: 100%;
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.12);
      transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .segment.filled {
      background: var(--segment-color);
    }

    /* Segment gradient colors - Red to Yellow to Green */
    .segment.filled.red-1 { background: #FF6B6B; }
    .segment.filled.red-2 { background: #FF7670; }
    .segment.filled.red-3 { background: #FF8075; }
    .segment.filled.red-4 { background: #FF8B7A; }
    .segment.filled.yellow-1 { background: #FF957F; }
    .segment.filled.yellow-2 { background: #FFA084; }
    .segment.filled.yellow-3 { background: #FFAA89; }
    .segment.filled.yellow-4 { background: #FFB58E; }
    .segment.filled.yellow-5 { background: #FFC093; }
    .segment.filled.yellow-6 { background: #FFCA98; }
    .segment.filled.yellow-7 { background: #FFD59D; }
    .segment.filled.yellow-8 { background: #FFE0A2; }
    .segment.filled.green-1 { background: #D4E89E; }
    .segment.filled.green-2 { background: #B9E89E; }
    .segment.filled.green-3 { background: #9FE89E; }
    .segment.filled.green-4 { background: #84E89E; }
    .segment.filled.green-5 { background: #6AE89E; }
    .segment.filled.green-6 { background: #5CE491; }
    .segment.filled.green-7 { background: #4FDF84; }
    .segment.filled.green-8 { background: #4CC38A; }

    .affordability-bottom-label {
      font-size: 13px;
      font-weight: 400;
      color: var(--text-low);
      text-align: left;
      letter-spacing: 0px;
      pointer-events: auto;
    }

    .affordability-bottom-label.negative {
      color: #FF6B6B;
    }

    /* More Info Section */
    .more-info-section {
      width: 100%;
      margin: 16px 0;
      align-self: flex-start;
    }

    .more-info-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 440px;
      padding: 12px 0;
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-high);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }

    .more-info-toggle:hover {
      color: var(--text-medium);
    }

    .more-info-toggle:active {
      transform: scale(0.99);
    }

    .chevron {
      font-size: 12px;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .more-info-toggle.expanded .chevron {
      transform: rotate(180deg);
    }

    .more-info-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .more-info-content.expanded {
      max-height: 500px;
    }

    /* Description */
    .product-description {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text-medium);
      max-width: 440px;
      margin: 16px 0 0 0;
      text-align: left;
      padding-bottom: 12px;
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 12px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 20px;
      margin-left: auto;
      margin-right: auto;
    }

    .btn {
      flex: 1;
      padding: 16px 24px;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      pointer-events: auto;
    }

    .btn-primary {
      background: #FFFFFF;
      color: #1A1A1A;
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }

    .btn-primary:active {
      transform: scale(0.97);
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.9);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.15);
      color: #FFFFFF;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:active {
      transform: scale(0.97);
      background: rgba(255, 255, 255, 0.25);
    }

    .btn-secondary.in-wishlist {
      background: rgba(255, 255, 255, 0.25);
      color: #FFFFFF;
      border-color: rgba(255, 255, 255, 0.5);
    }

    /* Related Products */
    .related-section {
      padding: 40px 20px 80px 20px;
      background: transparent;
      position: relative;
      z-index: 2;
    }

    .related-title {
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 24px;
      color: var(--text-high);
    }

    .related-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    .related-card {
      position: relative;
      aspect-ratio: 0.85;
      border-radius: 16px;
      overflow: hidden;
      background: var(--bg-surface);
      box-shadow: var(--shadow-m);
      cursor: pointer;
      transition: transform 0.2s;
      text-decoration: none;
    }

    .related-card:active {
      transform: scale(0.96);
    }

    .related-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .related-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.5) 0%, rgba(0, 0, 0, 0) 50%);
    }

    .related-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px;
      z-index: 1;
      color: white;
    }

    .related-card-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .related-card-price {
      font-size: 11px;
      opacity: 0.9;
    }

    /* Loading State */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      padding: 40px 20px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--accent-warm-gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 15px;
      color: var(--text-medium);
    }

    /* Error State */
    .error-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      padding: 40px 32px;
      text-align: center;
    }

    .error-icon {
      font-size: 56px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .error-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-high);
    }

    .error-message {
      font-size: 15px;
      line-height: 1.6;
      color: var(--text-medium);
      margin-bottom: 24px;
      max-width: 320px;
    }

    .hidden {
      display: none !important;
    }

    /* Bottom Navigation - Hidden */
    .bottom-nav {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <button class="back-btn" id="back-btn" aria-label="Go back">←</button>
    <button class="save-btn" id="save-btn">Save</button>
  </header>

  <!-- Loading State -->
  <div class="loading-state" id="loading-state">
    <div class="spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <!-- Error State -->
  <div class="error-state hidden" id="error-state">
    <div class="error-icon">⚠️</div>
    <h1 class="error-title">Product Not Found</h1>
    <p class="error-message">We couldn't find the product you're looking for. It may have been removed or the link might be incorrect.</p>
    <a href="discover.html" class="btn btn-primary" style="max-width: 200px;">Browse Products</a>
  </div>

  <!-- Product Content -->
  <div class="product-container hidden" id="product-content">
    <!-- Hero Image - Top 50% -->
    <section class="hero-section">
      <div class="hero-image-wrapper">
        <img id="hero-image" class="hero-image" src="" alt="Product" />
      </div>
    </section>

    <!-- Content Section - Bottom 50% -->
    <section class="content-section">
      <!-- Brand/Source -->
      <div class="product-brand" id="product-category">Category</div>

      <!-- Title -->
      <h1 class="product-title" id="product-title">Product Title</h1>

      <!-- Price -->
      <div class="product-price" id="product-price">$0</div>

      <!-- More Info Dropdown -->
      <div class="more-info-section">
        <button class="more-info-toggle" id="more-info-toggle">
          <span>More Info</span>
          <span class="chevron">▼</span>
        </button>
        <div class="more-info-content" id="more-info-content">
          <p class="product-description" id="product-description">
            A curated selection chosen for your lifestyle. This item fits your budget goals and personal preferences.
          </p>
        </div>
      </div>
    </section>

    <!-- Related Products -->
    <section class="related-section">
      <h2 class="related-title">You Might Also Like</h2>
      <div class="related-grid" id="related-grid">
        <!-- Populated by JavaScript -->
      </div>
    </section>
  </div>

  <!-- Affordability Bar - Sticky Bottom -->
  <div class="affordability-bar" id="affordability-bar">
    <!-- Buttons - Top of affordability bar -->
    <div class="button-group">
      <button class="btn btn-primary" id="buy-btn">Buy Now</button>
      <button class="btn btn-secondary" id="wishlist-btn">Add to Wishlist</button>
    </div>

    <div class="affordability-top-label" id="affordability-percentage">0% Affordable</div>
    <div class="segments-container" id="segments-container">
      <!-- 39 segments generated by JavaScript -->
    </div>
    <div class="affordability-bottom-label" id="affordability-remaining">Calculating...</div>
  </div>

  <script>
    // Product Data - Synced with feed.html
    const PRODUCTS = [
      // Core products (Under $50)
      { id: 1, subfilter: "core", title: "Daily Essentials Kit", subtitle: "$32", image: "https://images.unsplash.com/photo-1600585152220-90363fe7e115?w=800&q=80" },
      { id: 2, subfilter: "core", title: "Everyday Tote", subtitle: "$45", image: "https://images.unsplash.com/photo-1590874103328-eac38a683ce7?w=800&q=80" },
      { id: 3, subfilter: "core", title: "Basic Tech Organizer", subtitle: "$28", image: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&q=80" },
      { id: 4, subfilter: "core", title: "Coffee Subscription", subtitle: "$38/mo", image: "https://images.unsplash.com/photo-1497935586351-b67a49e012bf?w=800&q=80" },
      { id: 5, subfilter: "core", title: "Workout Basics", subtitle: "$49", image: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=800&q=80" },

      // Weekender products (Under $150)
      { id: 6, subfilter: "weekender", title: "Weekend Getaway Bag", subtitle: "$120", image: "https://images.unsplash.com/photo-1622560480654-d96214fdc887?w=800&q=80" },
      { id: 7, subfilter: "weekender", title: "Brunch Experience", subtitle: "$85", image: "https://images.unsplash.com/photo-1493770348161-369560ae357d?w=800&q=80" },
      { id: 8, subfilter: "weekender", title: "Spa Day Pass", subtitle: "$140", image: "https://images.unsplash.com/photo-1560750588-73207b1ef5b8?w=800&q=80" },
      { id: 9, subfilter: "weekender", title: "Concert Tickets", subtitle: "$95", image: "https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?w=800&q=80" },
      { id: 10, subfilter: "weekender", title: "Wine Tasting Tour", subtitle: "$135", image: "https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?w=800&q=80" },

      // Premium products ($150+)
      { id: 11, subfilter: "premium", title: "Designer Watch", subtitle: "$450", image: "https://images.unsplash.com/photo-1523170335258-f5ed11844a49?w=800&q=80" },
      { id: 12, subfilter: "premium", title: "Fine Dining Experience", subtitle: "$280", image: "https://images.unsplash.com/photo-1550966871-3ed3cdb5ed0c?w=800&q=80" },
      { id: 13, subfilter: "premium", title: "Luxury Skincare Set", subtitle: "$320", image: "https://images.unsplash.com/photo-1608248543803-ba4f8c70ae0b?w=800&q=80" },
      { id: 14, subfilter: "premium", title: "Premium Tech Gadget", subtitle: "$599", image: "https://images.unsplash.com/photo-1588872657578-7efd1f1555ed?w=800&q=80" },
      { id: 15, subfilter: "premium", title: "Artisan Furniture", subtitle: "$890", image: "https://images.unsplash.com/photo-1567538096630-e0c55bd6374c?w=800&q=80" },

      // Next products (Aspirational)
      { id: 16, subfilter: "next", title: "Travel Adventure", subtitle: "$2,400", image: "https://images.unsplash.com/photo-1488646953014-85cb44e25828?w=800&q=80" },
      { id: 17, subfilter: "next", title: "High-End Camera", subtitle: "$1,800", image: "https://images.unsplash.com/photo-1606986628825-1e0c1c7e4184?w=800&q=80" },
      { id: 18, subfilter: "next", title: "Luxury Weekend Retreat", subtitle: "$3,200", image: "https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800&q=80" },
      { id: 19, subfilter: "next", title: "Premium Home Office", subtitle: "$2,100", image: "https://images.unsplash.com/photo-1595526114035-0d45ed16cfbf?w=800&q=80" },

      // Safe products (Budget-friendly)
      { id: 20, subfilter: "safe", title: "Smart Shopping List", subtitle: "$22", image: "https://images.unsplash.com/photo-1586281380349-632531db7ed4?w=800&q=80" },
      { id: 21, subfilter: "safe", title: "Home Basics Bundle", subtitle: "$35", image: "https://images.unsplash.com/photo-1556911220-bff31c812dba?w=800&q=80" },
      { id: 22, subfilter: "safe", title: "Meal Prep Kit", subtitle: "$40", image: "https://images.unsplash.com/photo-1506368249639-73a05d6f6488?w=800&q=80" },
      { id: 23, subfilter: "safe", title: "Budget Fitness Gear", subtitle: "$29", image: "https://images.unsplash.com/photo-1598971861713-54ad16354c1c?w=800&q=80" }
    ];

    const SUBFILTER_NAMES = {
      core: "Essentials",
      weekender: "Lifestyle",
      premium: "Luxury",
      next: "Aspirational",
      safe: "Budget Friendly"
    };

    // Wishlist Management
    function getWishlist() {
      const wishlist = localStorage.getItem('wishlist');
      return wishlist ? JSON.parse(wishlist) : [];
    }

    function saveWishlist(wishlist) {
      localStorage.setItem('wishlist', JSON.stringify(wishlist));
    }

    function isInWishlist(productId) {
      return getWishlist().includes(productId);
    }

    function toggleWishlist(productId) {
      let wishlist = getWishlist();
      const index = wishlist.indexOf(productId);
      if (index > -1) {
        wishlist.splice(index, 1);
      } else {
        wishlist.push(productId);
      }
      saveWishlist(wishlist);
      return isInWishlist(productId);
    }

    // Get product ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = parseInt(urlParams.get('id'));
    const product = PRODUCTS.find(p => p.id === productId);

    // DOM elements
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const productContent = document.getElementById('product-content');
    const backBtn = document.getElementById('back-btn');
    const saveBtn = document.getElementById('save-btn');
    const wishlistBtn = document.getElementById('wishlist-btn');
    const buyBtn = document.getElementById('buy-btn');

    // Back navigation
    backBtn.addEventListener('click', () => {
      if (document.referrer && document.referrer !== window.location.href) {
        history.back();
      } else {
        window.location.href = 'discover.html';
      }
    });

    // Extract numeric price from subtitle
    function extractPrice(subtitle) {
      const match = subtitle.match(/\$?([\d,]+)/);
      return match ? parseInt(match[1].replace(',', '')) : 0;
    }

    // Generate 39 segments for full-width coverage
    function generateSegments() {
      const container = document.getElementById('segments-container');
      container.innerHTML = '';

      for (let i = 0; i < 39; i++) {
        const segment = document.createElement('div');
        segment.className = 'segment';
        segment.dataset.index = i;
        container.appendChild(segment);
      }
    }

    // Get segment color class based on position (0-38 for 39 segments)
    function getSegmentColorClass(index) {
      if (index < 10) {
        // Segments 0-9 (10 segments): red-1 to red-4 (distributed)
        const redIndex = Math.floor(index * 4 / 10) + 1;
        return `red-${Math.min(redIndex, 4)}`;
      } else if (index < 24) {
        // Segments 10-23 (14 segments): yellow-1 to yellow-8 (distributed)
        const yellowPosition = index - 10;
        const yellowIndex = Math.floor(yellowPosition * 8 / 14) + 1;
        return `yellow-${Math.min(yellowIndex, 8)}`;
      } else {
        // Segments 24-38 (15 segments): green-1 to green-8 (distributed)
        const greenPosition = index - 24;
        const greenIndex = Math.floor(greenPosition * 8 / 15) + 1;
        return `green-${Math.min(greenIndex, 8)}`;
      }
    }

    // Animate segments with staggered timing
    function animateSegments(percentage) {
      const segments = document.querySelectorAll('.segment');
      // Cap at 100% and calculate segments to fill (now out of 39)
      const cappedPercentage = Math.min(percentage, 100);
      const segmentsToFill = Math.ceil((cappedPercentage / 100) * 39);

      // Reset all segments first
      segments.forEach(seg => {
        seg.classList.remove('filled');
        seg.className = 'segment';
      });

      // Fill segments with staggered animation
      for (let i = 0; i < segmentsToFill; i++) {
        setTimeout(() => {
          const segment = segments[i];
          if (segment) {
            segment.classList.add('filled', getSegmentColorClass(i));
          }
        }, i * 20); // 20ms delay between each segment for smooth animation
      }
    }

    // Calculate affordability with new segmented bar
    function calculateAffordability(price) {
      // Mock user budget: $500
      const availableBudget = 500;
      const percentage = 65; // HARDCODED: Always show 65% affordable for all products
      const remaining = availableBudget - price;

      return {
        percentage: percentage,
        remaining: remaining,
        canAfford: false
      };
    }

    // Update affordability bar
    function updateAffordabilityBar(price) {
      const affordability = calculateAffordability(price);
      const percentageLabel = document.getElementById('affordability-percentage');
      const remainingLabel = document.getElementById('affordability-remaining');

      // Update percentage label
      percentageLabel.textContent = `${affordability.percentage}% Affordable`;

      // Update remaining budget label
      if (affordability.remaining >= 0) {
        remainingLabel.textContent = `$${affordability.remaining.toLocaleString()} remaining after purchase`;
        remainingLabel.classList.remove('negative');
      } else {
        remainingLabel.textContent = `–$${Math.abs(affordability.remaining).toLocaleString()} over budget if purchased`;
        remainingLabel.classList.add('negative');
      }

      // Animate segments
      animateSegments(affordability.percentage);
    }

    // Load product
    function loadProduct() {
      // Generate 24 segments on page load
      generateSegments();

      setTimeout(() => {
        loadingState.classList.add('hidden');

        if (!product) {
          errorState.classList.remove('hidden');
          document.title = 'Product Not Found • Budget App';
          return;
        }

        // Show product content
        productContent.classList.remove('hidden');
        document.title = `${product.title} • Budget App`;

        // Update content
        document.getElementById('hero-image').src = product.image;
        document.getElementById('hero-image').alt = product.title;
        document.getElementById('product-title').textContent = product.title;
        document.getElementById('product-category').textContent = SUBFILTER_NAMES[product.subfilter];
        document.getElementById('product-price').textContent = product.subtitle;

        // Calculate and show affordability with new segmented bar
        const price = extractPrice(product.subtitle);

        setTimeout(() => {
          updateAffordabilityBar(price);
        }, 300);

        // Update save button
        updateSaveButton();

        // Update wishlist button
        updateWishlistButton();

        // Load related products
        loadRelatedProducts();
      }, 300);
    }

    // Update save button (top right)
    function updateSaveButton() {
      if (isInWishlist(productId)) {
        saveBtn.textContent = 'Saved ✓';
        saveBtn.classList.add('saved');
      } else {
        saveBtn.textContent = 'Save';
        saveBtn.classList.remove('saved');
      }
    }

    // Update wishlist button (in content)
    function updateWishlistButton() {
      if (isInWishlist(productId)) {
        wishlistBtn.textContent = 'In Wishlist ✓';
        wishlistBtn.classList.add('in-wishlist');
      } else {
        wishlistBtn.textContent = 'Add to Wishlist';
        wishlistBtn.classList.remove('in-wishlist');
      }
    }

    // Save button click
    saveBtn.addEventListener('click', () => {
      toggleWishlist(productId);
      updateSaveButton();
      updateWishlistButton();

      saveBtn.style.transform = 'scale(0.9)';
      setTimeout(() => {
        saveBtn.style.transform = '';
      }, 150);
    });

    // Wishlist button click
    wishlistBtn.addEventListener('click', () => {
      toggleWishlist(productId);
      updateSaveButton();
      updateWishlistButton();
    });

    // Buy button click (placeholder)
    buyBtn.addEventListener('click', () => {
      alert('Purchase flow coming soon! This will integrate with your budget and payment methods.');
    });

    // Load related products
    function loadRelatedProducts() {
      const relatedGrid = document.getElementById('related-grid');

      let relatedProducts = PRODUCTS.filter(p =>
        p.subfilter === product.subfilter && p.id !== product.id
      );

      if (relatedProducts.length < 4) {
        const otherProducts = PRODUCTS.filter(p => p.id !== product.id && !relatedProducts.includes(p));
        relatedProducts = relatedProducts.concat(otherProducts.slice(0, 4 - relatedProducts.length));
      }

      relatedProducts = relatedProducts.slice(0, 4);

      relatedGrid.innerHTML = relatedProducts.map(p => `
        <a href="product.html?id=${p.id}" class="related-card">
          <img src="${p.image}" alt="${p.title}" />
          <div class="related-info">
            <div class="related-card-title">${p.title}</div>
            <div class="related-card-price">${p.subtitle}</div>
          </div>
        </a>
      `).join('');
    }

    // More Info Dropdown Toggle
    const moreInfoToggle = document.getElementById('more-info-toggle');
    const moreInfoContent = document.getElementById('more-info-content');

    if (moreInfoToggle && moreInfoContent) {
      moreInfoToggle.addEventListener('click', () => {
        const isExpanded = moreInfoContent.classList.contains('expanded');

        if (isExpanded) {
          // Collapse
          moreInfoContent.classList.remove('expanded');
          moreInfoToggle.classList.remove('expanded');
        } else {
          // Expand
          moreInfoContent.classList.add('expanded');
          moreInfoToggle.classList.add('expanded');
        }
      });
    }

    // Initialize
    loadProduct();
  </script>
</body>
</html>
